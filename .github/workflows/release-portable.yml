name: Release Portable Server

on:
  workflow_dispatch:
    inputs:
      bump:
        description: Semantic version bump type
        required: true
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

concurrency:
  group: release-portable
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22.x'

      - name: Install dependencies
        run: npm ci

      - name: Compute next version
        id: version
        shell: bash
        run: |
          set -euo pipefail

          bump="${{ github.event.inputs.bump }}"
          last_tag="$(git tag --list 'v*' | sort -V | tail -n 1)"

          if [[ -z "$last_tag" ]]; then
            next_version="1.0.0"
          else
            current="${last_tag#v}"
            IFS='.' read -r major minor patch <<< "$current"
            case "$bump" in
              major)
                major=$((major + 1))
                minor=0
                patch=0
                ;;
              minor)
                minor=$((minor + 1))
                patch=0
                ;;
              patch)
                patch=$((patch + 1))
                ;;
              *)
                echo "Unsupported bump type: $bump" >&2
                exit 1
                ;;
            esac
            next_version="$major.$minor.$patch"
          fi

          echo "version=$next_version" >> "$GITHUB_OUTPUT"
          echo "tag=v$next_version" >> "$GITHUB_OUTPUT"
          echo "Next version: $next_version"

      - name: Update version files
        run: |
          npm version --no-git-tag-version "${{ steps.version.outputs.version }}"
          echo "${{ steps.version.outputs.version }}" > VERSION

      - name: Commit and push version bump
        env:
          TAG: ${{ steps.version.outputs.tag }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add package.json package-lock.json VERSION
          git commit -m "chore(release): $TAG"
          git tag "$TAG"
          git push origin HEAD
          git push origin "$TAG"

      - name: Build portable binaries
        run: make build-portable-all

      - name: Package release artifacts
        env:
          VERSION: ${{ steps.version.outputs.version }}
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p release-artifacts
          cp dist/portable/* release-artifacts/
          chmod +x release-artifacts/scorched-darwin-amd64 release-artifacts/scorched-darwin-arm64 release-artifacts/scorched-linux-amd64 release-artifacts/scorched-linux-arm64

          if command -v sha256sum >/dev/null 2>&1; then
            (cd release-artifacts && sha256sum scorched-* > checksums.txt)
          else
            (cd release-artifacts && shasum -a 256 scorched-* > checksums.txt)
          fi

          (cd dist && zip -r "../release-artifacts/scorched-web-dist-v${VERSION}.zip" index.html assets)

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Portable Server ${{ steps.version.outputs.tag }}
          generate_release_notes: true
          files: |
            release-artifacts/scorched-windows-amd64.exe
            release-artifacts/scorched-darwin-amd64
            release-artifacts/scorched-darwin-arm64
            release-artifacts/scorched-linux-amd64
            release-artifacts/scorched-linux-arm64
            release-artifacts/checksums.txt
            release-artifacts/scorched-web-dist-v${{ steps.version.outputs.version }}.zip
